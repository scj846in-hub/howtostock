<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ìƒëŒ€ë¹„êµ ëŒ€ì‹œë³´ë“œ - ì „ë¬¸ê°€ í†µí•© V8</title>
    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f8fafc; --border: #e2e8f0; --danger: #ef4444; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); padding: 10px; font-size: 11px; color: #334155; }
        .container { max-width: 1600px; margin: auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; }
        .tabs { display: flex; background: #f1f5f9; border-bottom: 1px solid var(--border); overflow-x: auto; align-items: center; padding: 0 10px; }
        .tab-btn { padding: 12px 18px; border: none; cursor: pointer; background: none; font-weight: bold; color: #64748b; white-space: nowrap; }
        .tab-btn.active { background: #fff; color: var(--accent); border-bottom: 3px solid var(--accent); }
        .add-btn { padding: 6px 12px; cursor: pointer; background: #1e293b; color: #fff; border: none; border-radius: 4px; font-weight: bold; margin-right: 5px; font-size: 10px; }
        .eval-run-btn { padding: 8px 15px; cursor: pointer; background: var(--accent); color: #fff; border: none; border-radius: 4px; font-weight: bold; margin-left: auto; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        .section { border: 1px solid var(--border); padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #fff; }
        .section-header { font-size: 13px; font-weight: 800; color: var(--primary); margin-bottom: 10px; border-left: 4px solid var(--accent); padding-left: 8px; display: flex; justify-content: space-between; }
        .grid-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 8px; }
        .input-group { display: flex; flex-direction: column; gap: 3px; }
        label { font-size: 10px; font-weight: 700; color: #475569; }
        input, select { padding: 5px; border: 1px solid var(--border); border-radius: 4px; }
        input[readonly] { background: #f8fafc; color: var(--accent); font-weight: bold; }
        .val-display { background: #eff6ff; padding: 10px; border-radius: 6px; display: flex; justify-content: space-around; font-weight: bold; color: var(--accent); margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        th { background: #f8fafc; padding: 6px; border: 1px solid var(--border); font-size: 10px; }
        td { padding: 4px; border: 1px solid var(--border); text-align: center; }
        .row-disabled { opacity: 0.4; background: #f8fafc; pointer-events: none; }
        .delete-tab-btn { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 9px; font-weight: bold; }
        #evalModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 12px; box-shadow: 0 0 50px rgba(0,0,0,0.3); z-index: 1000; width: 300px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
    </style>
</head>
<body>

<div class="modal-overlay" id="overlay"></div>
<div id="evalModal">
    <h3 style="margin-top:0;">ğŸ“Š ë¹„êµ ëŒ€ìƒ ì„ íƒ</h3>
    <div id="checkList" style="margin-bottom: 20px;"></div>
    <div style="display:flex; gap:10px;">
        <button class="eval-run-btn" style="flex:1;" onclick="executeFinalCompare()">ë¹„êµ ì‹œì‘</button>
        <button class="eval-run-btn" style="flex:1; background:#64748b;" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>
</div>

<div class="container">
    <div class="tabs" id="tabList">
        <button class="add-btn" onclick="addNewStock()">+ íƒ­ ì¶”ê°€</button>
        <button class="eval-run-btn" onclick="openCompareModal()">ğŸ“Š ì¢…í•© ìƒëŒ€ë¹„êµ ì‹¤í–‰</button>
    </div>
    <div id="panels"></div>
    <div id="compare" class="tab-content">
        <h2 style="text-align:center;">ğŸ† ìµœì¢… íˆ¬ì ìš°ì„ ìˆœìœ„ ë¶„ì„ ê²°ê³¼</h2>
        <div id="dashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 15px;"></div>
    </div>
</div>

<script>
    let stockIdCounter = 0;
    const currentYearMonth = "2026-02";

    // 1. ì´ˆê¸° ì‹¤í–‰ ì‹œ ì¢…ëª© 2ê°œ ê¸°ë³¸ ìƒì„±
    window.onload = function() {
        addNewStock(); // ì¢…ëª© 1
        addNewStock(); // ì¢…ëª© 2
        openTab(null, 'stock_1');
    };

    function addNewStock() {
        stockIdCounter++;
        const id = `stock_${stockIdCounter}`;
        
        // [íƒ­ ë²„íŠ¼ ìƒì„±]
        const btn = document.createElement('button');
        btn.id = `btn_${id}`;
        btn.className = 'tab-btn';
        btn.innerText = `ì¢…ëª© ${stockIdCounter}`;
        btn.onclick = (e) => openTab(e, id);
        // ë²„íŠ¼ì„ '+ íƒ­ ì¶”ê°€' ë²„íŠ¼ ë°”ë¡œ ë’¤ì— ì‚½ì…
        const addBtn = document.querySelector('.add-btn');
        addBtn.parentNode.insertBefore(btn, addBtn.nextSibling);

        // [íŒ¨ë„ ì½˜í…ì¸  ìƒì„±]
        const panel = document.createElement('div');
        panel.id = id;
        panel.className = 'tab-content';
        panel.innerHTML = `
            <div class="val-display">
                <span>ë§¤ìˆ˜í¬ë§ê°€ ê¸°ì¤€ PER: <span id="dPer_${id}">-</span></span>
                <span>ë§¤ìˆ˜í¬ë§ê°€ ê¸°ì¤€ PBR: <span id="dPbr_${id}">-</span></span>
                <span>ë§¤ìˆ˜í¬ë§ê°€ ê¸°ì¤€ ì‹œì´: <span id="dMc_${id}">-</span></span>
            </div>

            <div class="section">
                <div class="section-header">
                    <span>ğŸ“ ê¸°ë³¸ ì •ë³´ ë° ì‹¤ì </span>
                    ${stockIdCounter > 2 ? `<button class="delete-tab-btn" onclick="deleteStock('${id}')">ì‚­ì œ</button>` : ''}
                </div>
                <div class="grid-row">
                    <div class="input-group"><label>ì¢…ëª©ëª…</label><input type="text" class="name" value="ì¢…ëª© ${stockIdCounter}" oninput="updateTabName('${id}', this.value)"></div>
                    <div class="input-group"><label>ë§¤ìˆ˜í¬ë§ê°€</label><input type="number" class="price" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ì£¼ì‹ìˆ˜</label><input type="number" class="shares" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ë§¤ì¶œì•¡</label><input type="number" class="rev" oninput="syncAll('${id}')"></div>
                </div>
                <div class="grid-row">
                    <div class="input-group"><label>ì˜ì—…ì´ìµ</label><input type="number" class="op" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ì˜ì—…ì´ìµë¥ </label><input type="text" class="opR" readonly></div>
                    <div class="input-group"><label>ë‹¹ê¸°ìˆœì´ìµ</label><input type="number" class="net" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ìˆœì´ìµë¥ </label><input type="text" class="netR" readonly></div>
                </div>
                <div class="grid-row">
                    <div class="input-group"><label>ìì‚°ì´ê³„</label><input type="number" class="assets" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ë¶€ì±„ì´ê³„</label><input type="number" class="debt" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ê³„ì‚°ìë³¸(ì°¸ê³ )</label><input type="text" class="cEquity" readonly></div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">ğŸ’° Valuation Band ë° ì‹œì¥ ëŒ€ë¹„ ìœ„ì¹˜</div>
                <div class="grid-row">
                    <div class="input-group"><label>5ê°œë…„ PER ë°´ë“œ(ìƒ/í•˜)</label><div><input type="number" class="perH" style="width:45%" oninput="syncAll('${id}')"><input type="number" class="perL" style="width:45%" oninput="syncAll('${id}')"></div></div>
                    <div class="input-group"><label>ê²½ìŸì‚¬ í‰ê·  PER</label><input type="number" class="avgPer" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>5ê°œë…„ PBR ë°´ë“œ(ìƒ/í•˜)</label><div><input type="number" class="pbrH" style="width:45%" oninput="syncAll('${id}')"><input type="number" class="pbrL" style="width:45%" oninput="syncAll('${id}')"></div></div>
                    <div class="input-group"><label>ê²½ìŸì‚¬ í‰ê·  PBR</label><input type="number" class="avgPbr" oninput="syncAll('${id}')"></div>
                </div>
                <div style="background:#fffbeb; padding:8px; border-radius:4px; font-weight:bold; margin-top:5px; line-height:1.6;">
                    ğŸ“Š [ë°´ë“œ ëŒ€ë¹„ ìœ„ì¹˜]: PER <span class="range-highlight" id="bandPer_${id}">-</span> | PBR <span class="range-highlight" id="bandPbr_${id}">-</span><br>
                    ğŸŒ [ì‹œì¥ í‰ê·  ëŒ€ë¹„]: PER <span class="range-highlight" id="indPer_${id}">-</span> | PBR <span class="range-highlight" id="indPbr_${id}">-</span>
                </div>
            </div>

            <div class="section">
                <div class="section-header">ğŸ†š ê²½ìŸì‚¬ ì„±ì¥ë¥  ë¹„êµ (ì²´í¬ ì‹œ í™œì„±í™”)</div>
                <table class="comp-table">
                    <thead><tr><th>í™œì„±</th><th>ê²½ìŸì‚¬ëª…</th><th>ë§¤ì¶œ(%)</th><th>ì˜ì—…ìµ(%)</th><th>ìˆœì´ìµ(%)</th></tr></thead>
                    <tbody>
                        <tr style="background:#f0f9ff"><td>âœ…</td><td><input type="text" value="ë‚´ ì¢…ëª©" readonly></td><td><input type="number" class="myRevG"></td><td><input type="number" class="myOpG"></td><td><input type="number" class="myNetG"></td></tr>
                        ${[0,1,2,3].map(idx => `
                        <tr class="${idx >= 2 ? 'row-disabled' : ''}">
                            <td><input type="checkbox" ${idx < 2 ? 'checked' : ''} onchange="toggleCompRow(this)"></td>
                            <td><input type="text" placeholder="ê²½ìŸì‚¬ëª…"></td>
                            <td><input type="number" class="cRevG"></td>
                            <td><input type="number" class="cOpG"></td>
                            <td><input type="number" class="cNetG"></td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>

            <div class="section">
                <div class="section-header">ğŸ“ˆ ì°¨íŠ¸ ë¶„ì„ (ëŒíŒŒ ëŒ€ê¸ˆ ë¹„ì¤‘)</div>
                <div class="grid-row">
                    <div class="input-group"><label>ì´í‰ì„  ì •ë°°ì—´</label><select class="ma"><option value="Y">Y</option><option value="N">N</option></select></div>
                    <div class="input-group"><label>ëŒíŒŒ ê±°ë˜ëŒ€ê¸ˆ</label><input type="number" class="breakVol" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ëŒ€ê¸ˆ/ì‹œì´ ë¹„ì¤‘</label><input type="text" class="volRatio" readonly></div>
                    <div class="input-group"><label>í˜„ì¬ê°€ > ëŒíŒŒ ì‹œê°€</label><select class="pricePos"><option value="Y">Y</option><option value="N">N</option></select></div>
                </div>
                <div class="grid-row">
                    <div class="input-group"><label>RSI/MACD ê³¼ë§¤ë„ íƒˆì¶œ(1-5)</label><input type="number" class="osc" min="1" max="5" value="3"></div>
                    <div class="input-group"><label>OBV ìœ ì§€(1-5)</label><input type="number" class="obv" min="1" max="5" value="3"></div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">ğŸ”” ê³µì‹œ ê°€ì¤‘í‰ê·  ë¶„ì„ (ê°€ì¤‘ì¹˜: ì¥ë‚´/ì¦ì—¬/ìƒì† 3ì , 3ìœ ì¦ 2ì , ê¸°íƒ€ 1ì )</div>
                <table id="eTable_${id}">
                    <thead><tr><th>ì¢…ë¥˜</th><th>ì‹œì </th><th>ê¸°ì¤€ê°€</th><th>ì´ê¸ˆì•¡</th><th>ê°€ì¤‘ì¹˜</th></tr></thead>
                    <tbody>
                        ${[1,2,3,4,5].map(() => `<tr>
                            <td><select class="eType">
                                <option value="3">ì¥ë‚´ë§¤ìˆ˜</option><option value="3">ì¦ì—¬</option><option value="3">ìƒì†</option>
                                <option value="2">ìœ ìƒì¦ì(3ì)</option><option value="1">ìœ ìƒì¦ì(ì¼ë°˜)</option>
                                <option value="1">CB</option><option value="1">ìì‚¬ì£¼</option>
                            </select></td>
                            <td><input type="month" class="eDate" oninput="syncAll('${id}')"></td>
                            <td><input type="number" class="eP" oninput="syncAll('${id}')"></td>
                            <td><input type="number" class="eA" oninput="syncAll('${id}')"></td>
                            <td><input type="text" class="eW" readonly></td>
                        </tr>`).join('')}
                    </tbody>
                </table>
                <div style="margin-top:5px; text-align:right; font-weight:bold;">ê°€ì¤‘í‰ê·  ë³´ì •ë‹¨ê°€: <span id="eAvg_${id}">0</span></div>
            </div>
        `;
        document.getElementById('panels').appendChild(panel);
    }

    function deleteStock(id) {
        if(confirm("ì´ ì¢…ëª© íƒ­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            document.getElementById(`btn_${id}`).remove();
            document.getElementById(id).remove();
            openTab(null, 'stock_1');
        }
    }

    function openTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(e) e.currentTarget.classList.add('active');
        else if(document.getElementById(`btn_${id}`)) document.getElementById(`btn_${id}`).classList.add('active');
    }

    function updateTabName(id, val) {
        document.getElementById(`btn_${id}`).innerText = val || `ì¢…ëª©`;
    }

    function toggleCompRow(cb) {
        cb.closest('tr').classList.toggle('row-disabled', !cb.checked);
    }

    function syncAll(id) {
        const p = document.getElementById(id);
        const price = parseFloat(p.querySelector('.price').value) || 0;
        const mc = price * (parseFloat(p.querySelector('.shares').value) || 0);
        const rev = parseFloat(p.querySelector('.rev').value) || 0;
        const net = parseFloat(p.querySelector('.net').value) || 0;
        const assets = parseFloat(p.querySelector('.assets').value) || 0;
        const debt = parseFloat(p.querySelector('.debt').value) || 0;
        const equity = assets - debt;

        if(rev > 0) {
            p.querySelector('.opR').value = ((parseFloat(p.querySelector('.op').value)||0)/rev*100).toFixed(1) + "%";
            p.querySelector('.netR').value = (net/rev*100).toFixed(1) + "%";
        }
        p.querySelector('.cEquity').value = equity.toLocaleString();
        document.getElementById(`dPer_${id}`).innerText = net !== 0 ? (mc/net).toFixed(2) : "-";
        document.getElementById(`dPbr_${id}`).innerText = equity !== 0 ? (mc/equity).toFixed(2) : "-";
        document.getElementById(`dMc_${id}`).innerText = mc.toLocaleString();

        const bVol = parseFloat(p.querySelector('.breakVol').value) || 0;
        if(mc > 0) p.querySelector('.volRatio').value = ((bVol/mc)*100).toFixed(2) + "%";

        const avgP = parseFloat(p.querySelector('.avgPer').value) || 0;
        if(avgP > 0 && net !== 0) document.getElementById(`indPer_${id}`).innerText = ((mc/net)/avgP*100).toFixed(1) + "%";

        let sumWP = 0, sumA = 0;
        p.querySelectorAll(`#eTable_${id} tbody tr`).forEach(r => {
            const ep = parseFloat(r.querySelector('.eP').value) || 0;
            const ea = parseFloat(r.querySelector('.eA').value) || 0;
            const tw = parseFloat(r.querySelector('.eType').value);
            const dateVal = r.querySelector('.eDate').value;
            if (ea > 0 && dateVal) {
                const diff = (2026 - parseInt(dateVal.split('-')[0])) * 12 + (2 - parseInt(dateVal.split('-')[1]));
                const timeWeight = Math.max(0.5, 1.5 - (diff / 24)); 
                const totalW = timeWeight * tw;
                r.querySelector('.eW').value = totalW.toFixed(1) + 'ë°°';
                sumWP += (ep * ea * totalW); sumA += (ea * totalW);
            }
        });
        document.getElementById(`eAvg_${id}`).innerText = sumA > 0 ? Math.round(sumWP/sumA).toLocaleString() : '0';
    }

    function openCompareModal() {
        const list = document.getElementById('checkList');
        list.innerHTML = "";
        document.querySelectorAll('.tab-btn:not(.add-btn)').forEach(btn => {
            if(btn.id) {
                const id = btn.id.replace('btn_', '');
                list.innerHTML += `<div style="margin-bottom:8px;"><label style="font-size:14px; cursor:pointer;"><input type="checkbox" value="${id}" checked> ${btn.innerText}</label></div>`;
            }
        });
        document.getElementById('evalModal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('evalModal').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    }

    function executeFinalCompare() {
        const selectedIds = Array.from(document.querySelectorAll('#checkList input:checked')).map(cb => cb.value);
        if(selectedIds.length === 0) return alert("ì¢…ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        
        let res = [];
        selectedIds.forEach(id => {
            const p = document.getElementById(id);
            const name = p.querySelector('.name').value;
            // ì¢…í•© ì ìˆ˜ ê³„ì‚° ë¡œì§
            let score = 50; 
            const vRatio = parseFloat(p.querySelector('.volRatio').value) || 0;
            if(vRatio > 5) score += 10;
            if(p.querySelector('.ma').value === 'Y') score += 10;
            
            res.push({ name, score: score + (Math.random()*20), indPer: document.getElementById(`indPer_${id}`).innerText });
        });
        
        res.sort((a,b) => b.score - a.score);
        document.getElementById('dashboard').innerHTML = res.map((r, idx) => `
            <div style="padding:15px; border:1px solid #e2e8f0; border-radius:10px; background:${idx===0?'#f0f9ff':'#fff'}">
                <h3>#${idx+1} ${r.name}</h3>
                <div style="font-size:24px; font-weight:bold; color:var(--accent);">${r.score.toFixed(1)}ì </div>
                <div style="margin-top:5px;">ì‚°ì—…í‰ê· ëŒ€ë¹„: ${r.indPer}</div>
            </div>
        `).join('');
        
        closeModal();
        openTab(null, 'compare');
    }
</script>
</body>
</html>
