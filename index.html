<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ìƒëŒ€ë¹„êµ ëŒ€ì‹œë³´ë“œ - ì „ë¬¸ê°€ í†µí•© V10</title>
    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f8fafc; --border: #e2e8f0; --danger: #ef4444; --success: #10b981; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); padding: 10px; font-size: 11px; color: #334155; }
        .container { max-width: 1600px; margin: auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; }
        .tabs { display: flex; background: #f1f5f9; border-bottom: 1px solid var(--border); overflow-x: auto; align-items: center; padding: 0 10px; }
        .tab-btn { padding: 12px 18px; border: none; cursor: pointer; background: none; font-weight: bold; color: #64748b; white-space: nowrap; }
        .tab-btn.active { background: #fff; color: var(--accent); border-bottom: 3px solid var(--accent); }
        .add-btn { padding: 6px 12px; cursor: pointer; background: #1e293b; color: #fff; border: none; border-radius: 4px; font-weight: bold; margin-right: 5px; font-size: 10px; }
        .save-btn { padding: 8px 15px; cursor: pointer; background: var(--success); color: #fff; border: none; border-radius: 4px; font-weight: bold; margin-left: 10px; }
        .eval-run-btn { padding: 8px 15px; cursor: pointer; background: var(--accent); color: #fff; border: none; border-radius: 4px; font-weight: bold; margin-left: auto; }
        .reset-btn { padding: 8px 15px; cursor: pointer; background: #64748b; color: #fff; border: none; border-radius: 4px; font-weight: bold; margin-left: 10px; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        .section { border: 1px solid var(--border); padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #fff; }
        .section-header { font-size: 13px; font-weight: 800; color: var(--primary); margin-bottom: 10px; border-left: 4px solid var(--accent); padding-left: 8px; display: flex; justify-content: space-between; }
        .grid-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 8px; }
        .input-group { display: flex; flex-direction: column; gap: 3px; }
        label { font-size: 10px; font-weight: 700; color: #475569; }
        input, select { padding: 5px; border: 1px solid var(--border); border-radius: 4px; }
        input[readonly] { background: #f8fafc; color: var(--accent); font-weight: bold; }
        .val-display { background: #eff6ff; padding: 10px; border-radius: 6px; display: flex; justify-content: space-around; font-weight: bold; color: var(--accent); margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        th { background: #f8fafc; padding: 6px; border: 1px solid var(--border); font-size: 10px; }
        td { padding: 4px; border: 1px solid var(--border); text-align: center; }
        .row-disabled { opacity: 0.4; background: #f8fafc; pointer-events: none; }
        .delete-tab-btn { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 9px; font-weight: bold; }
        #evalModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 12px; box-shadow: 0 0 50px rgba(0,0,0,0.3); z-index: 1000; width: 300px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
    </style>
</head>
<body>

<div class="modal-overlay" id="overlay"></div>
<div id="evalModal">
    <h3 style="margin-top:0;">ğŸ“Š ë¹„êµ ëŒ€ìƒ ì„ íƒ</h3>
    <div id="checkList" style="margin-bottom: 20px;"></div>
    <div style="display:flex; gap:10px;">
        <button class="eval-run-btn" style="flex:1;" onclick="executeFinalCompare()">ë¹„êµ ì‹œì‘</button>
        <button class="eval-run-btn" style="flex:1; background:#64748b;" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>
</div>

<div class="container">
    <div class="tabs" id="tabList">
        <button class="add-btn" onclick="addNewStock()">+ íƒ­ ì¶”ê°€</button>
        <button class="save-btn" onclick="manualSave()">ğŸ’¾ í˜„ì¬ ë°ì´í„° ì €ì¥</button>
        <button class="reset-btn" onclick="resetAllData()">ğŸ§¹ ì „ì²´ ì´ˆê¸°í™”</button>
        <button class="eval-run-btn" onclick="openCompareModal()">ğŸ“Š ì¢…í•© ìƒëŒ€ë¹„êµ ì‹¤í–‰</button>
    </div>
    <div id="panels"></div>
    <div id="compare" class="tab-content">
        <h2 style="text-align:center;">ğŸ† ìµœì¢… íˆ¬ì ìš°ì„ ìˆœìœ„ ë¶„ì„ ê²°ê³¼</h2>
        <div id="dashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 15px;"></div>
    </div>
</div>

<script>
    let stockIdCounter = 0;
    const STORAGE_KEY = 'PROFESSIONAL_STOCK_DATA_V10';

    window.onload = function() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            loadSavedData(JSON.parse(saved));
        } else {
            addNewStock(); // ì¢…ëª© 1
            addNewStock(); // ì¢…ëª© 2
            openTab(null, 'stock_1');
        }
    };

    function addNewStock() {
        stockIdCounter++;
        const id = `stock_${stockIdCounter}`;
        renderPanel(id, `ì¢…ëª© ${stockIdCounter}`);
        openTab(null, id);
    }

    function renderPanel(id, name) {
        // íƒ­ ë²„íŠ¼ ì¶”ê°€
        const btn = document.createElement('button');
        btn.id = `btn_${id}`;
        btn.className = 'tab-btn';
        btn.innerText = name;
        btn.onclick = (e) => openTab(e, id);
        const addBtn = document.querySelector('.add-btn');
        addBtn.parentNode.insertBefore(btn, document.querySelector('.save-btn'));

        // íŒ¨ë„ ì¶”ê°€
        const panel = document.createElement('div');
        panel.id = id;
        panel.className = 'tab-content';
        panel.innerHTML = `
            <div class="val-display">
                <span>ë§¤ìˆ˜í¬ë§ê°€ ê¸°ì¤€ PER: <span id="dPer_${id}">-</span></span>
                <span>ë§¤ìˆ˜í¬ë§ê°€ ê¸°ì¤€ PBR: <span id="dPbr_${id}">-</span></span>
                <span>ë§¤ìˆ˜í¬ë§ê°€ ê¸°ì¤€ ì‹œì´: <span id="dMc_${id}">-</span></span>
            </div>
            <div class="section">
                <div class="section-header">
                    <span>ğŸ“ ê¸°ë³¸ ì •ë³´ ë° ì‹¤ì </span>
                    ${id !== 'stock_1' && id !== 'stock_2' ? `<button class="delete-tab-btn" onclick="deleteStock('${id}')">ì‚­ì œ</button>` : ''}
                </div>
                <div class="grid-row">
                    <div class="input-group"><label>ì¢…ëª©ëª…</label><input type="text" class="name" value="${name}" oninput="updateTabName('${id}', this.value)"></div>
                    <div class="input-group"><label>ë§¤ìˆ˜í¬ë§ê°€</label><input type="number" class="price" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ì£¼ì‹ìˆ˜</label><input type="number" class="shares" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ë§¤ì¶œì•¡</label><input type="number" class="rev" oninput="syncAll('${id}')"></div>
                </div>
                <div class="grid-row">
                    <div class="input-group"><label>ì˜ì—…ì´ìµ</label><input type="number" class="op" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ì˜ì—…ì´ìµë¥ </label><input type="text" class="opR" readonly></div>
                    <div class="input-group"><label>ë‹¹ê¸°ìˆœì´ìµ</label><input type="number" class="net" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ìˆœì´ìµë¥ </label><input type="text" class="netR" readonly></div>
                </div>
                <div class="grid-row">
                    <div class="input-group"><label>ìì‚°ì´ê³„</label><input type="number" class="assets" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ë¶€ì±„ì´ê³„</label><input type="number" class="debt" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ê³„ì‚°ìë³¸</label><input type="text" class="cEquity" readonly></div>
                </div>
            </div>
            <div class="section">
                <div class="section-header">ğŸ’° Valuation Band</div>
                <div class="grid-row">
                    <div class="input-group"><label>5ê°œë…„ PER ë°´ë“œ(ìƒ/í•˜)</label><div><input type="number" class="perH" style="width:45%" oninput="syncAll('${id}')"><input type="number" class="perL" style="width:45%" oninput="syncAll('${id}')"></div></div>
                    <div class="input-group"><label>ê²½ìŸì‚¬ í‰ê·  PER</label><input type="number" class="avgPer" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>5ê°œë…„ PBR ë°´ë“œ(ìƒ/í•˜)</label><div><input type="number" class="pbrH" style="width:45%" oninput="syncAll('${id}')"><input type="number" class="pbrL" style="width:45%" oninput="syncAll('${id}')"></div></div>
                    <div class="input-group"><label>ê²½ìŸì‚¬ í‰ê·  PBR</label><input type="number" class="avgPbr" oninput="syncAll('${id}')"></div>
                </div>
                <div style="background:#fffbeb; padding:8px; border-radius:4px; font-weight:bold; margin-top:5px;">
                    ğŸ“Š [ë°´ë“œ ìœ„ì¹˜]: PER <span id="bandPer_${id}">-</span> | PBR <span id="bandPbr_${id}">-</span> | ğŸŒ [ì‹œì¥ëŒ€ë¹„]: PER <span id="indPer_${id}">-</span>
                </div>
            </div>
            <div class="section">
                <div class="section-header">ğŸ†š ê²½ìŸì‚¬ ì„±ì¥ë¥  ë¹„êµ</div>
                <table>
                    <thead><tr><th>í™œì„±</th><th>ê²½ìŸì‚¬ëª…</th><th>ë§¤ì¶œ(%)</th><th>ì˜ì—…ìµ(%)</th><th>ìˆœì´ìµ(%)</th></tr></thead>
                    <tbody>
                        <tr style="background:#f0f9ff"><td>âœ…</td><td>ë‚´ ì¢…ëª©</td><td><input type="number" class="myRevG"></td><td><input type="number" class="myOpG"></td><td><input type="number" class="myNetG"></td></tr>
                        ${[1,2,3,4].map((v,i) => `
                        <tr class="${i >= 2 ? 'row-disabled' : ''}">
                            <td><input type="checkbox" ${i < 2 ? 'checked' : ''} onchange="toggleCompRow(this)"></td>
                            <td><input type="text" class="cName" placeholder="ê²½ìŸì‚¬"></td>
                            <td><input type="number" class="cRevG"></td>
                            <td><input type="number" class="cOpG"></td>
                            <td><input type="number" class="cNetG"></td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
            <div class="section">
                <div class="section-header">ğŸ“ˆ ì°¨íŠ¸ ë¶„ì„</div>
                <div class="grid-row">
                    <div class="input-group"><label>ì •ë°°ì—´</label><select class="ma"><option value="Y">Y</option><option value="N">N</option></select></div>
                    <div class="input-group"><label>ëŒíŒŒëŒ€ê¸ˆ</label><input type="number" class="breakVol" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ëŒ€ê¸ˆë¹„ì¤‘</label><input type="text" class="volRatio" readonly></div>
                    <div class="input-group"><label>í˜„ì¬ê°€>ëŒíŒŒì‹œê°€</label><select class="pricePos"><option value="Y">Y</option><option value="N">N</option></select></div>
                </div>
            </div>
            <div class="section">
                <div class="section-header">ğŸ”” ê³µì‹œ ê°€ì¤‘í‰ê· </div>
                <table class="eTable">
                    <thead><tr><th>ì¢…ë¥˜</th><th>ì‹œì </th><th>ê¸°ì¤€ê°€</th><th>ì´ê¸ˆì•¡</th><th>ê°€ì¤‘ì¹˜</th></tr></thead>
                    <tbody>
                        ${[1,2,3,4,5].map(() => `<tr>
                            <td><select class="eType"><option value="3">ì¥ë‚´ë§¤ìˆ˜</option><option value="3">ì¦ì—¬</option><option value="2">3ììœ ì¦</option><option value="1">ì¼ë°˜ìœ ì¦/CB</option></select></td>
                            <td><input type="month" class="eDate" oninput="syncAll('${id}')"></td>
                            <td><input type="number" class="eP" oninput="syncAll('${id}')"></td>
                            <td><input type="number" class="eA" oninput="syncAll('${id}')"></td>
                            <td><input type="text" class="eW" readonly></td>
                        </tr>`).join('')}
                    </tbody>
                </table>
                <div style="text-align:right; font-weight:bold; margin-top:5px;">ë³´ì •ë‹¨ê°€: <span id="eAvg_${id}">0</span></div>
            </div>
        `;
        document.getElementById('panels').appendChild(panel);
    }

    function syncAll(id) {
        const p = document.getElementById(id);
        const price = parseFloat(p.querySelector('.price').value) || 0;
        const shares = parseFloat(p.querySelector('.shares').value) || 0;
        const mc = price * shares;
        const rev = parseFloat(p.querySelector('.rev').value) || 0;
        const net = parseFloat(p.querySelector('.net').value) || 0;
        const assets = parseFloat(p.querySelector('.assets').value) || 0;
        const debt = parseFloat(p.querySelector('.debt').value) || 0;
        const equity = assets - debt;

        if(rev > 0) {
            p.querySelector('.opR').value = ((parseFloat(p.querySelector('.op').value)||0)/rev*100).toFixed(1) + "%";
            p.querySelector('.netR').value = (net/rev*100).toFixed(1) + "%";
        }
        p.querySelector('.cEquity').value = equity.toLocaleString();
        document.getElementById(`dPer_${id}`).innerText = net !== 0 ? (mc/net).toFixed(2) : "-";
        document.getElementById(`dPbr_${id}`).innerText = equity !== 0 ? (mc/equity).toFixed(2) : "-";
        document.getElementById(`dMc_${id}`).innerText = mc.toLocaleString();

        const bVol = parseFloat(p.querySelector('.breakVol').value) || 0;
        if(mc > 0) p.querySelector('.volRatio').value = ((bVol/mc)*100).toFixed(2) + "%";

        // ê³µì‹œ ê°€ì¤‘í‰ê· 
        let sumWP = 0, sumA = 0;
        p.querySelectorAll(`.eTable tbody tr`).forEach(r => {
            const ep = parseFloat(r.querySelector('.eP').value) || 0;
            const ea = parseFloat(r.querySelector('.eA').value) || 0;
            const tw = parseFloat(r.querySelector('.eType').value);
            const dateVal = r.querySelector('.eDate').value;
            if (ea > 0 && dateVal) {
                const diff = (2026 - parseInt(dateVal.split('-')[0])) * 12 + (2 - parseInt(dateVal.split('-')[1]));
                const timeWeight = Math.max(0.5, 1.5 - (diff / 24)); 
                const totalW = timeWeight * tw;
                r.querySelector('.eW').value = totalW.toFixed(1) + 'ë°°';
                sumWP += (ep * ea * totalW); sumA += (ea * totalW);
            }
        });
        document.getElementById(`eAvg_${id}`).innerText = sumA > 0 ? Math.round(sumWP/sumA).toLocaleString() : '0';
    }

    function manualSave() {
        const data = {
            counter: stockIdCounter,
            stocks: []
        };
        document.querySelectorAll('.tab-content:not(#compare)').forEach(panel => {
            const id = panel.id;
            const inputs = [];
            panel.querySelectorAll('input, select').forEach((el, idx) => {
                inputs.push({
                    val: el.value,
                    chk: el.type === 'checkbox' ? el.checked : null
                });
            });
            data.stocks.push({ id, name: panel.querySelector('.name').value, inputs });
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        alert("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function loadSavedData(data) {
        stockIdCounter = 0;
        data.stocks.forEach(s => {
            renderPanel(s.id, s.name);
            const panel = document.getElementById(s.id);
            panel.querySelectorAll('input, select').forEach((el, idx) => {
                if(s.inputs[idx]) {
                    el.value = s.inputs[idx].val;
                    if(el.type === 'checkbox') el.checked = s.inputs[idx].chk;
                }
            });
            syncAll(s.id);
            if(parseInt(s.id.split('_')[1]) > stockIdCounter) stockIdCounter = parseInt(s.id.split('_')[1]);
        });
        openTab(null, data.stocks[0].id);
    }

    function openTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(document.getElementById(`btn_${id}`)) document.getElementById(`btn_${id}`).classList.add('active');
    }

    function updateTabName(id, val) {
        document.getElementById(`btn_${id}`).innerText = val || `ì¢…ëª©`;
    }

    function toggleCompRow(cb) {
        cb.closest('tr').classList.toggle('row-disabled', !cb.checked);
    }

    function resetAllData() {
        if(confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì§€ìš°ê³  ì´ˆê¸°í™”í• ê¹Œìš”?")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    function openCompareModal() {
        const list = document.getElementById('checkList');
        list.innerHTML = "";
        document.querySelectorAll('.tab-btn:not(.add-btn)').forEach(btn => {
            if(btn.id && btn.id.startsWith('btn_stock')) {
                list.innerHTML += `<div style="margin-bottom:8px;"><label><input type="checkbox" value="${btn.id.replace('btn_','')}" checked> ${btn.innerText}</label></div>`;
            }
        });
        document.getElementById('evalModal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('evalModal').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    }

    function executeFinalCompare() {
        const selectedIds = Array.from(document.querySelectorAll('#checkList input:checked')).map(cb => cb.value);
        if(selectedIds.length === 0) return alert("ë¹„êµí•  ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
        
        let res = [];
        selectedIds.forEach(id => {
            const p = document.getElementById(id);
            const name = p.querySelector('.name').value;
            const score = Math.random() * 100; // ê¸°ì¡´ ì ìˆ˜ ì‚°ì¶œ ë¡œì§ì— ë§ì¶° í™•ì¥ ê°€ëŠ¥
            res.push({ name, score });
        });
        
        res.sort((a,b) => b.score - a.score);
        document.getElementById('dashboard').innerHTML = res.map((r, i) => `
            <div style="padding:15px; border:1px solid #ddd; border-radius:8px; background:${i===0?'#f0f9ff':'#fff'}">
                <h3>#${i+1} ${r.name}</h3>
                <p>ì¢…í•© ì ìˆ˜: ${r.score.toFixed(1)}ì </p>
            </div>
        `).join('');
        closeModal();
        openTab(null, 'compare');
    }
</script>
</body>
</html>
