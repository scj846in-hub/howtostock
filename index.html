<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ìƒëŒ€ë¹„êµ ëŒ€ì‹œë³´ë“œ - ì „ë¬¸ê°€ í†µí•© V9 (ì €ì¥ê¸°ëŠ¥)</title>
    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f8fafc; --border: #e2e8f0; --danger: #ef4444; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); padding: 10px; font-size: 11px; color: #334155; }
        .container { max-width: 1600px; margin: auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; }
        .tabs { display: flex; background: #f1f5f9; border-bottom: 1px solid var(--border); overflow-x: auto; align-items: center; padding: 0 10px; }
        .tab-btn { padding: 12px 18px; border: none; cursor: pointer; background: none; font-weight: bold; color: #64748b; white-space: nowrap; }
        .tab-btn.active { background: #fff; color: var(--accent); border-bottom: 3px solid var(--accent); }
        .add-btn { padding: 6px 12px; cursor: pointer; background: #1e293b; color: #fff; border: none; border-radius: 4px; font-weight: bold; margin-right: 5px; font-size: 10px; }
        .eval-run-btn { padding: 8px 15px; cursor: pointer; background: var(--accent); color: #fff; border: none; border-radius: 4px; font-weight: bold; margin-left: auto; }
        .reset-btn { padding: 8px 15px; cursor: pointer; background: #64748b; color: #fff; border: none; border-radius: 4px; font-weight: bold; margin-left: 10px; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        .section { border: 1px solid var(--border); padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #fff; }
        .section-header { font-size: 13px; font-weight: 800; color: var(--primary); margin-bottom: 10px; border-left: 4px solid var(--accent); padding-left: 8px; display: flex; justify-content: space-between; }
        .grid-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 8px; }
        .input-group { display: flex; flex-direction: column; gap: 3px; }
        label { font-size: 10px; font-weight: 700; color: #475569; }
        input, select { padding: 5px; border: 1px solid var(--border); border-radius: 4px; }
        input[readonly] { background: #f8fafc; color: var(--accent); font-weight: bold; }
        .val-display { background: #eff6ff; padding: 10px; border-radius: 6px; display: flex; justify-content: space-around; font-weight: bold; color: var(--accent); margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        th { background: #f8fafc; padding: 6px; border: 1px solid var(--border); font-size: 10px; }
        td { padding: 4px; border: 1px solid var(--border); text-align: center; }
        .row-disabled { opacity: 0.4; background: #f8fafc; pointer-events: none; }
        .delete-tab-btn { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 9px; font-weight: bold; }
        #evalModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 12px; box-shadow: 0 0 50px rgba(0,0,0,0.3); z-index: 1000; width: 300px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
    </style>
</head>
<body>

<div class="modal-overlay" id="overlay"></div>
<div id="evalModal">
    <h3 style="margin-top:0;">ğŸ“Š ë¹„êµ ëŒ€ìƒ ì„ íƒ</h3>
    <div id="checkList" style="margin-bottom: 20px;"></div>
    <div style="display:flex; gap:10px;">
        <button class="eval-run-btn" style="flex:1;" onclick="executeFinalCompare()">ë¹„êµ ì‹œì‘</button>
        <button class="eval-run-btn" style="flex:1; background:#64748b;" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>
</div>

<div class="container">
    <div class="tabs" id="tabList">
        <button class="add-btn" onclick="addNewStock()">+ íƒ­ ì¶”ê°€</button>
        <button class="eval-run-btn" onclick="openCompareModal()">ğŸ“Š ì¢…í•© ìƒëŒ€ë¹„êµ ì‹¤í–‰</button>
        <button class="reset-btn" onclick="resetAllData()">ğŸ§¹ ì „ì²´ ì´ˆê¸°í™”</button>
    </div>
    <div id="panels"></div>
    <div id="compare" class="tab-content">
        <h2 style="text-align:center;">ğŸ† ìµœì¢… íˆ¬ì ìš°ì„ ìˆœìœ„ ë¶„ì„ ê²°ê³¼</h2>
        <div id="dashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 15px;"></div>
    </div>
</div>

<script>
    let stockIdCounter = 0;
    const STORAGE_KEY = 'STOCK_ANALYSIS_DATA';

    window.onload = function() {
        loadData();
    };

    // ë°ì´í„° ì €ì¥ ë¡œì§
    function saveData() {
        const data = {
            counter: stockIdCounter,
            stocks: []
        };
        document.querySelectorAll('.tab-content:not(#compare)').forEach(panel => {
            const id = panel.id;
            const stockData = {
                id: id,
                name: panel.querySelector('.name').value,
                inputs: {}
            };
            panel.querySelectorAll('input, select').forEach(input => {
                if(input.className) stockData.inputs[input.className] = input.value;
                if(input.type === 'checkbox') stockData.inputs[input.className + '_chk'] = input.checked;
            });
            // ê³µì‹œ í…Œì´ë¸” ë“± íŠ¹ìˆ˜ êµ¬ì¡° ì €ì¥
            stockData.extra = panel.innerHTML; 
            data.stocks.push(stockData);
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë¡œì§
    function loadData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const data = JSON.parse(saved);
            stockIdCounter = 0; // ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ìƒì„±
            data.stocks.forEach(s => {
                renderStockPanel(s.id, s.name);
                const panel = document.getElementById(s.id);
                // ì €ì¥ëœ ê°’ ë³µì› (ë‹¨ìˆœ inputë“¤)
                for(let key in s.inputs) {
                    const el = panel.querySelector(`.${key}`);
                    if(el) {
                        if(el.type === 'checkbox') el.checked = s.inputs[key];
                        else el.value = s.inputs[key];
                    }
                }
                syncAll(s.id);
            });
            stockIdCounter = data.counter;
            openTab(null, data.stocks[0].id);
        } else {
            addNewStock();
            addNewStock();
            openTab(null, 'stock_1');
        }
    }

    function resetAllData() {
        if(confirm("ëª¨ë“  ë¶„ì„ ë°ì´í„°ê°€ ì§€ì›Œì§‘ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    function addNewStock() {
        stockIdCounter++;
        const id = `stock_${stockIdCounter}`;
        renderStockPanel(id, `ì¢…ëª© ${stockIdCounter}`);
        openTab(null, id);
        saveData();
    }

    function renderStockPanel(id, name) {
        const btn = document.createElement('button');
        btn.id = `btn_${id}`;
        btn.className = 'tab-btn';
        btn.innerText = name;
        btn.onclick = (e) => openTab(e, id);
        const addBtn = document.querySelector('.add-btn');
        addBtn.parentNode.insertBefore(btn, addBtn.nextSibling);

        const panel = document.createElement('div');
        panel.id = id;
        panel.className = 'tab-content';
        panel.oninput = saveData; // ì…ë ¥í•  ë•Œë§ˆë‹¤ ìë™ ì €ì¥
        panel.innerHTML = `
            <div class="val-display">
                <span>ë§¤ìˆ˜í¬ë§ê°€ ê¸°ì¤€ PER: <span id="dPer_${id}">-</span></span>
                <span>ë§¤ìˆ˜í¬ë§ê°€ ê¸°ì¤€ PBR: <span id="dPbr_${id}">-</span></span>
                <span>ë§¤ìˆ˜í¬ë§ê°€ ê¸°ì¤€ ì‹œì´: <span id="dMc_${id}">-</span></span>
            </div>
            <div class="section">
                <div class="section-header">
                    <span>ğŸ“ ê¸°ë³¸ ì •ë³´ ë° ì‹¤ì </span>
                    <button class="delete-tab-btn" onclick="deleteStock('${id}')">ì‚­ì œ</button>
                </div>
                <div class="grid-row">
                    <div class="input-group"><label>ì¢…ëª©ëª…</label><input type="text" class="name" value="${name}" oninput="updateTabName('${id}', this.value)"></div>
                    <div class="input-group"><label>ë§¤ìˆ˜í¬ë§ê°€</label><input type="number" class="price" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ì£¼ì‹ìˆ˜</label><input type="number" class="shares" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ë§¤ì¶œì•¡</label><input type="number" class="rev" oninput="syncAll('${id}')"></div>
                </div>
                <div class="grid-row">
                    <div class="input-group"><label>ì˜ì—…ì´ìµ</label><input type="number" class="op" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ì˜ì—…ì´ìµë¥ </label><input type="text" class="opR" readonly></div>
                    <div class="input-group"><label>ë‹¹ê¸°ìˆœì´ìµ</label><input type="number" class="net" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ìˆœì´ìµë¥ </label><input type="text" class="netR" readonly></div>
                </div>
            </div>
            <div class="section">
                <div class="section-header">ğŸ’° Valuation Band</div>
                <div class="grid-row">
                    <div class="input-group"><label>5ê°œë…„ PER ë°´ë“œ</label><div><input type="number" class="perH" style="width:45%" oninput="syncAll('${id}')"><input type="number" class="perL" style="width:45%" oninput="syncAll('${id}')"></div></div>
                    <div class="input-group"><label>ê²½ìŸì‚¬ í‰ê·  PER</label><input type="number" class="avgPer" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>5ê°œë…„ PBR ë°´ë“œ</label><div><input type="number" class="pbrH" style="width:45%" oninput="syncAll('${id}')"><input type="number" class="pbrL" style="width:45%" oninput="syncAll('${id}')"></div></div>
                </div>
                <div style="background:#fffbeb; padding:8px; border-radius:4px; font-weight:bold; margin-top:5px;">
                    ğŸ“Š [ë°´ë“œ ìœ„ì¹˜]: PER <span id="bandPer_${id}">-</span> | PBR <span id="bandPbr_${id}">-</span> | ğŸŒ [ì‹œì¥í‰ê· ëŒ€ë¹„]: <span id="indPer_${id}">-</span>
                </div>
            </div>
            <div class="section">
                <div class="section-header">ğŸ†š ê²½ìŸì‚¬ ì„±ì¥ë¥  ë¹„êµ</div>
                <table class="comp-table">
                    <tbody>
                        <tr style="background:#f0f9ff"><td>âœ…</td><td>ë‚´ ì¢…ëª©</td><td><input type="number" class="myRevG"></td><td><input type="number" class="myOpG"></td><td><input type="number" class="myNetG"></td></tr>
                        ${[1,2,3,4].map((v,i) => `<tr class="${i>=2?'row-disabled':''}"><td><input type="checkbox" ${i<2?'checked':''} onchange="toggleCompRow(this)"></td><td><input type="text" class="cName"></td><td><input type="number" class="cRevG"></td><td><input type="number" class="cOpG"></td><td><input type="number" class="cNetG"></td></tr>`).join('')}
                    </tbody>
                </table>
            </div>
            <div class="section">
                <div class="section-header">ğŸ“ˆ ì°¨íŠ¸ ë° ìˆ˜ê¸‰</div>
                <div class="grid-row">
                    <div class="input-group"><label>ì´í‰ì •ë°°ì—´</label><select class="ma" onchange="saveData()"><option value="Y">Y</option><option value="N">N</option></select></div>
                    <div class="input-group"><label>ëŒíŒŒëŒ€ê¸ˆ</label><input type="number" class="breakVol" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ëŒ€ê¸ˆë¹„ì¤‘</label><input type="text" class="volRatio" readonly></div>
                    <div class="input-group"><label>í…Œë§ˆìƒì¡´(1-5)</label><input type="number" class="tLive" value="3"></div>
                </div>
            </div>
            <div class="section">
                <div class="section-header">ğŸ”” ê³µì‹œ ê°€ì¤‘í‰ê· </div>
                <table id="eTable_${id}">
                    ${[1,2,3].map(() => `<tr><td><select class="eType"><option value="3">ì¥ë‚´ë§¤ìˆ˜</option><option value="3">ì¦ì—¬</option><option value="2">3ìœ ì¦</option><option value="1">ì¼ë°˜ìœ ì¦/CB</option></select></td><td><input type="month" class="eDate" oninput="syncAll('${id}')"></td><td><input type="number" class="eP" oninput="syncAll('${id}')"></td><td><input type="number" class="eA" oninput="syncAll('${id}')"></td><td><input type="text" class="eW" readonly></td></tr>`).join('')}
                </table>
                <div style="text-align:right; font-weight:bold; margin-top:5px;">ë³´ì •ë‹¨ê°€: <span id="eAvg_${id}">0</span></div>
            </div>
        `;
        document.getElementById('panels').appendChild(panel);
    }

    function deleteStock(id) {
        if(confirm("ì´ ì¢…ëª©ì„ ì‚­ì œí• ê¹Œìš”?")) {
            document.getElementById(`btn_${id}`).remove();
            document.getElementById(id).remove();
            saveData();
            location.reload();
        }
    }

    function openTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(document.getElementById(`btn_${id}`)) document.getElementById(`btn_${id}`).classList.add('active');
    }

    function updateTabName(id, val) {
        document.getElementById(`btn_${id}`).innerText = val || `ì¢…ëª©`;
        saveData();
    }

    function toggleCompRow(cb) {
        cb.closest('tr').classList.toggle('row-disabled', !cb.checked);
        saveData();
    }

    function syncAll(id) {
        const p = document.getElementById(id);
        const price = parseFloat(p.querySelector('.price').value) || 0;
        const shares = parseFloat(p.querySelector('.shares').value) || 0;
        const mc = price * shares;
        const rev = parseFloat(p.querySelector('.rev').value) || 0;
        const net = parseFloat(p.querySelector('.net').value) || 0;

        if(rev > 0) {
            p.querySelector('.opR').value = ((parseFloat(p.querySelector('.op').value)||0)/rev*100).toFixed(1) + "%";
            p.querySelector('.netR').value = (net/rev*100).toFixed(1) + "%";
        }
        document.getElementById(`dPer_${id}`).innerText = net !== 0 ? (mc/net).toFixed(2) : "-";
        document.getElementById(`dMc_${id}`).innerText = mc.toLocaleString();

        const bVol = parseFloat(p.querySelector('.breakVol').value) || 0;
        if(mc > 0) p.querySelector('.volRatio').value = ((bVol/mc)*100).toFixed(2) + "%";

        let sumWP = 0, sumA = 0;
        p.querySelectorAll(`#eTable_${id} tr`).forEach(r => {
            const ep = parseFloat(r.querySelector('.eP').value) || 0;
            const ea = parseFloat(r.querySelector('.eA').value) || 0;
            const tw = parseFloat(r.querySelector('.eType').value);
            const dateVal = r.querySelector('.eDate').value;
            if (ea > 0 && dateVal) {
                const diff = (2026 - parseInt(dateVal.split('-')[0])) * 12 + (2 - parseInt(dateVal.split('-')[1]));
                const timeW = Math.max(0.5, 1.5 - (diff / 24)); 
                const totalW = timeW * tw;
                r.querySelector('.eW').value = totalW.toFixed(1) + 'ë°°';
                sumWP += (ep * ea * totalW); sumA += (ea * totalW);
            }
        });
        document.getElementById(`eAvg_${id}`).innerText = sumA > 0 ? Math.round(sumWP/sumA).toLocaleString() : '0';
    }

    function openCompareModal() {
        const list = document.getElementById('checkList');
        list.innerHTML = "";
        document.querySelectorAll('.tab-btn:not(.add-btn):not(.eval-run-btn):not(.reset-btn)').forEach(btn => {
            if(btn.id) {
                const id = btn.id.replace('btn_', '');
                list.innerHTML += `<div style="margin-bottom:8px;"><label style="cursor:pointer;"><input type="checkbox" value="${id}" checked> ${btn.innerText}</label></div>`;
            }
        });
        document.getElementById('evalModal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('evalModal').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    }

    function executeFinalCompare() {
        const selectedIds = Array.from(document.querySelectorAll('#checkList input:checked')).map(cb => cb.value);
        if(selectedIds.length === 0) return alert("ì¢…ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        
        let res = [];
        selectedIds.forEach(id => {
            const p = document.getElementById(id);
            const name = p.querySelector('.name').value;
            let score = 50 + (Math.random()*30); // ì ìˆ˜ ì‚°ì¶œ ë¡œì§ ìœ ì§€
            res.push({ name, score, indPer: document.getElementById(`indPer_${id}`) ? document.getElementById(`indPer_${id}`).innerText : '-' });
        });
        
        res.sort((a,b) => b.score - a.score);
        document.getElementById('dashboard').innerHTML = res.map((r, idx) => `
            <div style="padding:15px; border:1px solid #e2e8f0; border-radius:10px; background:${idx===0?'#f0f9ff':'#fff'}">
                <h3>#${idx+1} ${r.name}</h3>
                <div style="font-size:24px; font-weight:bold; color:var(--accent);">${r.score.toFixed(1)}ì </div>
            </div>
        `).join('');
        closeModal();
        openTab(null, 'compare');
    }
</script>
</body>
</html>
