<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ìƒëŒ€ë¹„êµ ëŒ€ì‹œë³´ë“œ - ì „ë¬¸ê°€ìš© ìµœì¢… í†µí•©ë³¸</title>
    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f8fafc; --border: #e2e8f0; --danger: #ef4444; --success: #10b981; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); padding: 10px; font-size: 11px; color: #334155; }
        .container { max-width: 1600px; margin: auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; }
        
        .header-bar { display: flex; background: #f1f5f9; border-bottom: 1px solid var(--border); align-items: center; padding: 0 15px; flex-wrap: wrap; }
        .tabs-container { display: flex; overflow-x: auto; flex-grow: 1; align-items: center; }
        .action-btns { display: flex; gap: 8px; padding: 10px 0; }
        
        .tab-btn { padding: 12px 18px; border: none; cursor: pointer; background: none; font-weight: bold; color: #64748b; white-space: nowrap; border-bottom: 3px solid transparent; }
        .tab-btn.active { background: #fff; color: var(--accent); border-bottom: 3px solid var(--accent); }
        
        .btn { padding: 8px 14px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; font-size: 10.5px; color: #fff; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .btn-add { background: #1e293b; }
        .btn-save { background: var(--success); }
        .btn-reset { background: #64748b; }
        .btn-compare { background: var(--accent); }
        .btn:hover { opacity: 0.8; }

        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        .section { border: 1px solid var(--border); padding: 18px; border-radius: 8px; margin-bottom: 18px; background: #fff; position: relative; }
        .section-header { font-size: 13px; font-weight: 800; color: var(--primary); margin-bottom: 12px; border-left: 4px solid var(--accent); padding-left: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        .grid-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 10px; }
        .input-group { display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 10px; font-weight: 700; color: #475569; }
        input, select { padding: 7px; border: 1px solid var(--border); border-radius: 4px; font-size: 11px; outline: none; }
        input:focus { border-color: var(--accent); }
        input[readonly] { background: #f8fafc; color: var(--accent); font-weight: bold; border: 1px solid #dbeafe; }
        
        .val-display { background: #eff6ff; padding: 15px; border-radius: 8px; display: flex; justify-content: space-around; font-weight: bold; color: var(--accent); margin-bottom: 20px; border: 1px solid #dbeafe; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        th { background: #f8fafc; padding: 8px; border: 1px solid var(--border); font-size: 10px; color: #64748b; }
        td { padding: 6px; border: 1px solid var(--border); text-align: center; }
        .row-disabled { opacity: 0.4; background: #f8fafc; pointer-events: none; }
        .delete-tab-btn { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 10px; font-weight: bold; }

        #evalModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 12px; box-shadow: 0 0 50px rgba(0,0,0,0.3); z-index: 1000; width: 340px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
    </style>
</head>
<body>

<div class="modal-overlay" id="overlay"></div>
<div id="evalModal">
    <h3 style="margin-top:0;">ğŸ“Š ë¹„êµ ëŒ€ìƒ ì„ íƒ</h3>
    <p style="color:#64748b; margin-bottom:15px;">ì¢…í•© ê²°ê³¼ì— í¬í•¨í•  ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”.</p>
    <div id="checkList" style="max-height: 250px; overflow-y: auto; margin-bottom: 20px; border: 1px solid var(--border); padding: 5px; border-radius: 6px;"></div>
    <div style="display:flex; gap:10px;">
        <button class="btn btn-compare" style="flex:2; justify-content: center;" onclick="executeFinalCompare()">ë¹„êµ ì‹¤í–‰</button>
        <button class="btn btn-reset" style="flex:1; justify-content: center;" onclick="closeModal()">ë‹«ê¸°</button>
    </div>
</div>

<div class="container">
    <div class="header-bar">
        <div class="tabs-container" id="tabList"></div>
        <div class="action-btns">
            <button class="btn btn-add" onclick="addNewStock()">+ íƒ­ ì¶”ê°€</button>
            <button class="btn btn-save" onclick="manualSave()">ğŸ’¾ í˜„ì¬ ë°ì´í„° ì €ì¥</button>
            <button class="btn btn-reset" onclick="resetAllData()">ğŸ§¹ ì´ˆê¸°í™”</button>
            <button class="btn btn-compare" onclick="openCompareModal()">ğŸ“Š ì¢…í•©ë¹„êµ</button>
        </div>
    </div>

    <div id="panels"></div>
    
    <div id="compare" class="tab-content">
        <h2 style="text-align:center;">ğŸ† íˆ¬ì ìš°ì„ ìˆœìœ„ ë¶„ì„ ê²°ê³¼</h2>
        <div id="dashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 15px;"></div>
    </div>
</div>

<script>
    let stockIdCounter = 0;
    const STORAGE_KEY = 'STOCK_ULTIMATE_V13';

    window.onload = function() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            loadSavedData(JSON.parse(saved));
        } else {
            addNewStock();
            addNewStock();
            openTab(null, 'stock_1');
        }
    };

    function addNewStock() {
        stockIdCounter++;
        const id = `stock_${stockIdCounter}`;
        const name = `ì¢…ëª© ${stockIdCounter}`;
        
        const btn = document.createElement('button');
        btn.id = `btn_${id}`;
        btn.className = 'tab-btn';
        btn.innerText = name;
        btn.onclick = (e) => openTab(e, id);
        document.getElementById('tabList').appendChild(btn);

        const panel = document.createElement('div');
        panel.id = id;
        panel.className = 'tab-content';
        panel.innerHTML = `
            <div class="val-display">
                <span>[ë§¤ìˆ˜í¬ë§ê°€] PER: <span id="dPer_${id}">-</span></span>
                <span>PBR: <span id="dPbr_${id}">-</span></span>
                <span>ì‹œê°€ì´ì•¡: <span id="dMc_${id}">-</span></span>
            </div>

            <div class="section">
                <div class="section-header">
                    <span>ğŸ“ ê¸°ë³¸ ì •ë³´ ë° ì‹¤ì  ë¶„ì„</span>
                    <button class="delete-tab-btn" onclick="deleteStock('${id}')">íƒ­ ì‚­ì œ</button>
                </div>
                <div class="grid-row">
                    <div class="input-group"><label>ì¢…ëª©ëª…</label><input type="text" class="name" value="${name}" oninput="updateTabName('${id}', this.value)"></div>
                    <div class="input-group"><label>ë§¤ìˆ˜í¬ë§ê°€</label><input type="number" class="price" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ì£¼ì‹ìˆ˜</label><input type="number" class="shares" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ë§¤ì¶œì•¡</label><input type="number" class="rev" oninput="syncAll('${id}')"></div>
                </div>
                <div class="grid-row">
                    <div class="input-group"><label>ì˜ì—…ì´ìµ</label><input type="number" class="op" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ì˜ì—…ìµë¥ </label><input type="text" class="opR" readonly></div>
                    <div class="input-group"><label>ìˆœì´ìµ</label><input type="number" class="net" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ìˆœì´ìµë¥ </label><input type="text" class="netR" readonly></div>
                </div>
                <div class="grid-row">
                    <div class="input-group"><label>ìì‚°ì´ê³„</label><input type="number" class="assets" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ë¶€ì±„ì´ê³„</label><input type="number" class="debt" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ìê¸°ìë³¸(ê³„ì‚°)</label><input type="text" class="cEquity" readonly></div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">ğŸ’° Valuation Band (ì‹œì¥ ëŒ€ë¹„ ìœ„ì¹˜)</div>
                <div class="grid-row">
                    <div class="input-group"><label>5ê°œë…„ PER ìƒë‹¨</label><input type="number" class="perH" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>5ê°œë…„ PER í•˜ë‹¨</label><input type="number" class="perL" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ê²½ìŸì‚¬ í‰ê·  PER</label><input type="number" class="avgPer" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>5ê°œë…„ PBR ìƒë‹¨</label><input type="number" class="pbrH" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>5ê°œë…„ PBR í•˜ë‹¨</label><input type="number" class="pbrL" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ê²½ìŸì‚¬ í‰ê·  PBR</label><input type="number" class="avgPbr" oninput="syncAll('${id}')"></div>
                </div>
                <div style="background:#fffbeb; padding:10px; border-radius:6px; font-weight:bold; margin-top:5px; border:1px solid #fef3c7;">
                    ğŸ“Š [í˜„ì¬ ìœ„ì¹˜]: PER ë°´ë“œ <span id="bandPer_${id}">-</span>% | PBR ë°´ë“œ <span id="bandPbr_${id}">-</span>% | ğŸŒ ê²½ìŸì‚¬ ëŒ€ë¹„ PER: <span id="indPer_${id}">-</span>%
                </div>
            </div>

            <div class="section">
                <div class="section-header">ğŸ†š ê²½ìŸì‚¬ ì„±ì¥ë¥  ë¹„êµ ë¶„ì„</div>
                <table>
                    <thead><tr><th>í™œì„±</th><th>ê¸°ì—…ëª…</th><th>ë§¤ì¶œì¦ê°€ìœ¨(%)</th><th>ì˜ì—…ìµì¦ê°€ìœ¨(%)</th><th>ìˆœì´ìµì¦ê°€ìœ¨(%)</th></tr></thead>
                    <tbody>
                        <tr style="background:#f0f9ff"><td>âœ…</td><td><input type="text" value="ë‚´ ì¢…ëª©" readonly></td><td><input type="number" class="myRevG"></td><td><input type="number" class="myOpG"></td><td><input type="number" class="myNetG"></td></tr>
                        ${[1,2,3,4].map(i => `
                        <tr class="${i > 2 ? 'row-disabled' : ''}">
                            <td><input type="checkbox" ${i <= 2 ? 'checked' : ''} onchange="toggleCompRow(this)"></td>
                            <td><input type="text" class="cName" placeholder="ê²½ìŸì‚¬ëª…"></td>
                            <td><input type="number" class="cRevG"></td>
                            <td><input type="number" class="cOpG"></td>
                            <td><input type="number" class="cNetG"></td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>

            <div class="section">
                <div class="section-header">ğŸ“ˆ ì°¨íŠ¸ ë° ìˆ˜ê¸‰ í…Œë§ˆ (ì •ì„± í‰ê°€)</div>
                <div class="grid-row">
                    <div class="input-group"><label>ì´í‰ì„  ì •ë°°ì—´</label><select class="ma"><option value="Y">Y</option><option value="N">N</option></select></div>
                    <div class="input-group"><label>ëŒíŒŒ ê±°ë˜ëŒ€ê¸ˆ</label><input type="number" class="breakVol" oninput="syncAll('${id}')"></div>
                    <div class="input-group"><label>ëŒ€ê¸ˆ/ì‹œì´ ë¹„ì¤‘</label><input type="text" class="volRatio" readonly></div>
                    <div class="input-group"><label>í˜„ì¬ê°€>ëŒíŒŒì‹œê°€</label><select class="pricePos"><option value="Y">Y</option><option value="N">N</option></select></div>
                </div>
                <div class="grid-row">
                    <div class="input-group"><label>RSI/MACD(1-5)</label><input type="number" class="osc" value="3"></div>
                    <div class="input-group"><label>OBV ì¶”ì„¸(1-5)</label><input type="number" class="obv" value="3"></div>
                    <div class="input-group"><label>í…Œë§ˆ ìƒì¡´ë ¥(1-5)</label><input type="number" class="tLive" value="3"></div>
                    <div class="input-group"><label>í…Œë§ˆ ëŒ€ì¥ì£¼(1-5)</label><input type="number" class="tLead" value="1"></div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">ğŸ”” ê³µì‹œ ê°€ì¤‘í‰ê·  ë³´ì •ë‹¨ê°€</div>
                <table class="eTable">
                    <thead><tr><th>ê³µì‹œì¢…ë¥˜</th><th>ë°œìƒì‹œì </th><th>ê¸°ì¤€ê°€</th><th>ì´ê¸ˆì•¡(ì–µ)</th><th>ê°€ì¤‘ì¹˜</th></tr></thead>
                    <tbody>
                        ${[1,2,3,4,5].map(() => `<tr>
                            <td><select class="eType"><option value="3">ì¥ë‚´ë§¤ìˆ˜/ì¦ì—¬/ìƒì†</option><option value="2">3ìë°°ì • ìœ ì¦</option><option value="1">ì¼ë°˜ìœ ì¦/CB/BW</option></select></td>
                            <td><input type="month" class="eDate" oninput="syncAll('${id}')"></td>
                            <td><input type="number" class="eP" oninput="syncAll('${id}')"></td>
                            <td><input type="number" class="eA" oninput="syncAll('${id}')"></td>
                            <td><input type="text" class="eW" readonly></td>
                        </tr>`).join('')}
                    </tbody>
                </table>
                <div style="text-align:right; font-weight:bold; margin-top:12px; font-size:13px; color:var(--accent);">
                    ê°€ì¤‘í‰ê·  ë³´ì •ë‹¨ê°€: <span id="eAvg_${id}">0</span>
                </div>
            </div>
        `;
        document.getElementById('panels').appendChild(panel);
        openTab(null, id);
    }

    function syncAll(id) {
        const p = document.getElementById(id);
        const price = parseFloat(p.querySelector('.price').value) || 0;
        const shares = parseFloat(p.querySelector('.shares').value) || 0;
        const mc = price * shares;
        const rev = parseFloat(p.querySelector('.rev').value) || 0;
        const net = parseFloat(p.querySelector('.net').value) || 0;
        const assets = parseFloat(p.querySelector('.assets').value) || 0;
        const debt = parseFloat(p.querySelector('.debt').value) || 0;
        const equity = assets - debt;

        if(rev > 0) {
            p.querySelector('.opR').value = ((parseFloat(p.querySelector('.op').value)||0)/rev*100).toFixed(1) + "%";
            p.querySelector('.netR').value = (net/rev*100).toFixed(1) + "%";
        }
        p.querySelector('.cEquity').value = equity.toLocaleString();
        
        const per = net !== 0 ? (mc/net) : 0;
        const pbr = equity !== 0 ? (mc/equity) : 0;
        
        document.getElementById(`dPer_${id}`).innerText = per !== 0 ? per.toFixed(2) : "-";
        document.getElementById(`dPbr_${id}`).innerText = pbr !== 0 ? pbr.toFixed(2) : "-";
        document.getElementById(`dMc_${id}`).innerText = mc.toLocaleString();

        const perH = parseFloat(p.querySelector('.perH').value) || 0;
        const perL = parseFloat(p.querySelector('.perL').value) || 0;
        if(perH > perL && per > 0) {
            document.getElementById(`bandPer_${id}`).innerText = (((per - perL) / (perH - perL)) * 100).toFixed(1);
        }

        const avgPer = parseFloat(p.querySelector('.avgPer').value) || 0;
        if(avgPer > 0 && per > 0) {
            document.getElementById(`indPer_${id}`).innerText = ((per / avgPer) * 100).toFixed(1);
        }

        const bVol = parseFloat(p.querySelector('.breakVol').value) || 0;
        if(mc > 0) p.querySelector('.volRatio').value = ((bVol/mc)*100).toFixed(2) + "%";

        let sumWP = 0, sumA = 0;
        p.querySelectorAll(`.eTable tbody tr`).forEach(r => {
            const ep = parseFloat(r.querySelector('.eP').value) || 0;
            const ea = parseFloat(r.querySelector('.eA').value) || 0;
            const tw = parseFloat(r.querySelector('.eType').value);
            const dateVal = r.querySelector('.eDate').value;
            if (ea > 0 && dateVal) {
                const diff = (2026 - parseInt(dateVal.split('-')[0])) * 12 + (2 - parseInt(dateVal.split('-')[1]));
                const timeWeight = Math.max(0.5, 1.5 - (diff / 24)); 
                const totalW = timeWeight * tw;
                r.querySelector('.eW').value = totalW.toFixed(1) + 'ë°°';
                sumWP += (ep * ea * totalW); sumA += (ea * totalW);
            }
        });
        document.getElementById(`eAvg_${id}`).innerText = sumA > 0 ? Math.round(sumWP/sumA).toLocaleString() : '0';
    }

    function manualSave() {
        const data = {
            counter: stockIdCounter,
            stocks: []
        };
        document.querySelectorAll('.tab-content:not(#compare)').forEach(panel => {
            const inputs = [];
            panel.querySelectorAll('input, select').forEach(el => {
                inputs.push({
                    val: el.value,
                    chk: el.type === 'checkbox' ? el.checked : null,
                    class: el.className
                });
            });
            data.stocks.push({ id: panel.id, name: panel.querySelector('.name').value, inputs });
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        alert("âœ… ëª¨ë“  ì°¨íŠ¸ ë¶„ì„ ë° ì…ë ¥ ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function loadSavedData(data) {
        stockIdCounter = 0;
        data.stocks.forEach(s => {
            addNewStock();
            const panel = document.getElementById(s.id);
            const fields = panel.querySelectorAll('input, select');
            s.inputs.forEach((inputData, idx) => {
                if(fields[idx]) {
                    fields[idx].value = inputData.val;
                    if(fields[idx].type === 'checkbox') {
                        fields[idx].checked = inputData.chk;
                        toggleCompRow(fields[idx]);
                    }
                }
            });
            updateTabName(s.id, s.name);
            syncAll(s.id);
            const numId = parseInt(s.id.split('_')[1]);
            if(numId > stockIdCounter) stockIdCounter = numId;
        });
        openTab(null, data.stocks[0].id);
    }

    function openTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(document.getElementById(`btn_${id}`)) document.getElementById(`btn_${id}`).classList.add('active');
    }

    function updateTabName(id, val) {
        const btn = document.getElementById(`btn_${id}`);
        if(btn) btn.innerText = val || `ì¢…ëª©`;
    }

    function deleteStock(id) {
        if(confirm("ì´ ì¢…ëª©ì˜ ëª¨ë“  ë¶„ì„ ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?")) {
            document.getElementById(`btn_${id}`).remove();
            document.getElementById(id).remove();
            const first = document.querySelector('.tab-btn');
            if(first) first.click();
        }
    }

    function toggleCompRow(cb) {
        cb.closest('tr').classList.toggle('row-disabled', !cb.checked);
    }

    function resetAllData() {
        if(confirm("ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì§€ìš°ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    function openCompareModal() {
        const list = document.getElementById('checkList');
        list.innerHTML = "";
        document.querySelectorAll('.tab-btn').forEach(btn => {
            const id = btn.id.replace('btn_','');
            list.innerHTML += `
                <div style="padding:10px; border-bottom:1px solid #f1f5f9;">
                    <label style="display:flex; align-items:center; gap:12px; cursor:pointer;">
                        <input type="checkbox" value="${id}" checked style="width:18px; height:18px;">
                        <span style="font-weight:bold; font-size:13px;">${btn.innerText}</span>
                    </label>
                </div>`;
        });
        document.getElementById('evalModal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('evalModal').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    }

    function executeFinalCompare() {
        const selectedIds = Array.from(document.querySelectorAll('#checkList input:checked')).map(cb => cb.value);
        if(selectedIds.length === 0) return alert("ë¹„êµí•  ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

        let res = [];
        selectedIds.forEach(id => {
            const p = document.getElementById(id);
            const name = p.querySelector('.name').value;
            
            // ì ìˆ˜ ì•Œê³ ë¦¬ì¦˜ ë³µêµ¬ ë° ê°•í™”
            let score = 50;
            if(p.querySelector('.ma').value === 'Y') score += 10;
            if(p.querySelector('.pricePos').value === 'Y') score += 10;
            const vRatio = parseFloat(p.querySelector('.volRatio').value) || 0;
            if(vRatio > 5) score += 10;
            score += (parseInt(p.querySelector('.tLive').value) || 0) * 2;
            score += (parseInt(p.querySelector('.obv').value) || 0) * 2;

            res.push({ name, score, per: document.getElementById(`dPer_${id}`).innerText, mc: document.getElementById(`dMc_${id}`).innerText });
        });

        res.sort((a,b) => b.score - a.score);
        document.getElementById('dashboard').innerHTML = res.map((r, i) => `
            <div style="padding:20px; border:2px solid ${i===0?'var(--accent)':'#e2e8f0'}; border-radius:12px; background:${i===0?'#f0f9ff':'#fff'}; position:relative;">
                ${i===0?'<span style="position:absolute; top:-10px; right:15px; background:var(--accent); color:white; padding:3px 12px; border-radius:15px; font-size:10px; font-weight:bold;">RANK #1</span>':''}
                <h3 style="margin:0 0 12px 0; font-size:16px;">${r.name}</h3>
                <div style="font-size:32px; font-weight:900; color:var(--accent);">${Math.round(r.score)}ì </div>
                <div style="margin-top:15px; padding-top:15px; border-top:1px dashed #cbd5e1; color:#64748b; font-size:11px; line-height:1.6;">
                    â€¢ ë¶„ì„ ì‹œê°€ì´ì•¡: ${r.mc}ì–µ<br>
                    â€¢ ì ìš© PER: ${r.per}ë°°
                </div>
            </div>
        `).join('');

        closeModal();
        openTab(null, 'compare');
    }
</script>
</body>
</html>
